<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aivora AI Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo"><i class="fas fa-robot"></i> Aivora</span>
      <button id="hideSidebarBtn" class="sidebar-toggle"><i class="fas fa-times"></i></button>
    </div>

    <button class="new-chat-btn" onclick="startNewChat()">
      <i class="fas fa-plus"></i> New Chat
    </button>

    <div id="chat-history-list"></div>

    <div class="sidebar-footer">
      <button class="sidebar-btn" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
      <button class="sidebar-btn" onclick="clearAllChats()">
        <i class="fas fa-trash"></i> Clear All Chats
      </button>
      <a href="/logout" class="sidebar-btn" style="color: #ff6b6b;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </div>

  <!-- Sidebar Toggle Button (Mobile) -->
  <button id="showSidebarBtn" class="sidebar-show-btn" style="display: none;">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Main Content -->
  <div class="main">
    <div class="top-bar">
      <div class="top-bar-title">Aivora AI Assistant</div>
      <div class="top-bar-actions">
        <button class="action-btn" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <div class="chat-container" id="chatbox"></div>

    <div class="input-area">
      <form id="multi-action-form" enctype="multipart/form-data">
        <select id="action-type">
          <option value="ask">Ask AI</option>
          <option value="upload_image">Upload Image</option>
        </select>

        <input type="text" id="text-input" name="instruction" placeholder="Ask Aivora anything..." required />
        
        <label for="file-input" class="file-input-label" id="file-input-label" style="display: none;">
          <i class="fas fa-image"></i>
        </label>
        <input type="file" id="file-input" name="image" accept="image/*" />

        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </form>
    </div>

    <div class="loader" id="loader">
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize dark mode
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
      }

      // DOM Elements
      const chatbox = document.getElementById('chatbox');
      const chatHistoryList = document.getElementById('chat-history-list');
      const textInput = document.getElementById('text-input');
      const fileInput = document.getElementById('file-input');
      const fileInputLabel = document.getElementById('file-input-label');
      const actionType = document.getElementById('action-type');
      const loader = document.getElementById('loader');
      const sidebar = document.getElementById('sidebar');
      const showSidebarBtn = document.getElementById('showSidebarBtn');
      const hideSidebarBtn = document.getElementById('hideSidebarBtn');

      let currentChatId = null;
      let chatTitle = '';

      // Initialize Highlight.js
      hljs.highlightAll();

      // Configure marked (Markdown parser)
      marked.setOptions({
        breaks: true,
        highlight: function(code, lang) {
          const language = hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        }
      });

      // Sidebar toggle functionality
      showSidebarBtn.addEventListener('click', () => {
        sidebar.classList.add('visible');
      });

      hideSidebarBtn.addEventListener('click', () => {
        sidebar.classList.remove('visible');
      });

      // Toggle file input visibility based on action type
      actionType.addEventListener('change', function () {
        if (this.value === 'upload_image') {
          fileInputLabel.style.display = 'flex';
          textInput.placeholder = 'Add optional caption...';
        } else {
          fileInputLabel.style.display = 'none';
          textInput.placeholder = 'Ask Aivora anything...';
        }
      });

      // Form submission handler
      document.getElementById('multi-action-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const type = actionType.value;
        loader.style.display = 'block';

        if (type === 'ask') {
          const userText = textInput.value.trim();
          if (!userText) {
            alert("Please enter your question");
            loader.style.display = 'none';
            return;
          }
          addMessage(userText, 'user');
          const response = await askAI(userText);
          addMessage(response, 'bot');
        } 
        else if (type === 'upload_image') {
          if (fileInput.files.length === 0) {
            alert("Please select an image to upload");
            loader.style.display = 'none';
            return;
          }
          addMessage('Uploading image...', 'user');
          const response = await uploadImage(fileInput.files[0]);
          addMessage(response, 'bot');
        }

        textInput.value = '';
        fileInput.value = '';
        loader.style.display = 'none';
        textInput.focus();
      });

      // Enhanced addMessage function
      function addMessage(text, type = 'bot') {
        const msg = document.createElement('div');
        msg.className = `chat-message ${type}-message`;
        
        // Create message header
        const header = document.createElement('div');
        header.className = 'message-header';
        
        if (type === 'user') {
          header.innerHTML = '<i class="fas fa-user"></i> You';
        } else {
          header.innerHTML = '<i class="fas fa-robot"></i> Aivora';
        }
        
        msg.appendChild(header);
        
        // Process message content (parse markdown and format sections)
        const content = document.createElement('div');
        content.className = 'message-content';
        
        // Parse structured response format
        if (type === 'bot' && text.includes('**Concise Direct Answer:**')) {
          const sections = text.split(/\d+\.\s+\*\*.*?\*\*:/g).slice(1);
          const titles = text.match(/\d+\.\s+\*\*(.*?)\*\*:/g) || [];
          
          titles.forEach((title, index) => {
            const cleanTitle = title.replace(/\d+\.\s+\*\*|\*\*:/g, '');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'message-section';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'section-title';
            
            // Add appropriate icon based on section
            let icon = 'fa-info-circle';
            if (cleanTitle.includes('Examples')) icon = 'fa-list-ul';
            else if (cleanTitle.includes('Explanation')) icon = 'fa-lightbulb';
            else if (cleanTitle.includes('Context')) icon = 'fa-book';
            
            titleDiv.innerHTML = `<i class="fas ${icon}"></i> ${cleanTitle}`;
            sectionDiv.appendChild(titleDiv);
            
            // Process content with markdown
            const contentDiv = document.createElement('div');
            let sectionContent = sections[index]?.trim() || '';
            
            // Special handling for code blocks
            if (cleanTitle.includes('Answer') && sectionContent.includes('```')) {
              sectionContent = sectionContent.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<div class="code-block"><div class="code-header"><span class="code-language">${lang || 'python'}</span><button class="copy-btn" onclick="copyToClipboard(this)"><i class="far fa-copy"></i> Copy</button></div><pre><code class="${lang || 'python'}">${code.trim()}</code></pre></div>`;
              });
            }
            
            contentDiv.innerHTML = marked.parse(sectionContent);
            sectionDiv.appendChild(contentDiv);
            content.appendChild(sectionDiv);
          });
        } 
        else {
          // Regular message processing
          content.innerHTML = marked.parse(text);
        }
        
        msg.appendChild(content);
        chatbox.appendChild(msg);
        chatbox.scrollTop = chatbox.scrollHeight;

        // Highlight any code blocks
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });

        // Save to chat history
        if (!currentChatId) {
          const userQuery = textInput.value.trim();
          chatTitle = userQuery.substring(0, 30) || "New Chat";
          currentChatId = 'chat_' + Date.now();
          localStorage.setItem(currentChatId, JSON.stringify([]));
        }

        const chat = JSON.parse(localStorage.getItem(currentChatId)) || [];
        chat.push({ type, text });
        localStorage.setItem(currentChatId, JSON.stringify(chat));
        updateChatHistory();
      }

      // Update chat history list
      function updateChatHistory() {
        chatHistoryList.innerHTML = '';
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('chat_')) {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-link';
            if (key === currentChatId) chatItem.classList.add('active');
            
            // Try to get the first user message as title
            let title = 'Chat';
            try {
              const messages = JSON.parse(localStorage.getItem(key));
              const firstUserMsg = messages.find(m => m.type === 'user');
              if (firstUserMsg) {
                title = firstUserMsg.text.substring(0, 30);
                if (firstUserMsg.text.length > 30) title += '...';
              }
            } catch (e) {
              console.error('Error parsing chat history:', e);
            }
            
            chatItem.innerHTML = `<i class="far fa-comment"></i> ${title}`;
            chatItem.onclick = () => loadChat(key);
            chatHistoryList.appendChild(chatItem);
          }
        });
      }

      // Load chat from history
      function loadChat(key) {
        currentChatId = key;
        chatbox.innerHTML = '';
        try {
          const messages = JSON.parse(localStorage.getItem(key));
          messages.forEach(msg => {
            addMessage(msg.text, msg.type);
          });
          
          // Update active state in sidebar
          document.querySelectorAll('.chat-link').forEach(link => {
            link.classList.remove('active');
          });
          document.querySelector(`.chat-link[onclick="loadChat('${key}')"]`).classList.add('active');
        } catch (e) {
          console.error('Error loading chat:', e);
        }
      }

      // Start new chat
      async function startNewChat() {
        try {
          const response = await fetch('/start_new_chat', { method: 'POST' });
          const data = await response.json();
          if (data.response) {
            currentChatId = null;
            chatbox.innerHTML = '';
            textInput.value = '';
            fileInput.value = '';
            updateChatHistory();
          }
        } catch (error) {
          console.error("Error starting new chat:", error);
        }
      }

      // Clear all chats
      window.clearAllChats = function() {
        if (confirm('Are you sure you want to clear all chat history?')) {
          Object.keys(localStorage).forEach(key => {
            if (key.startsWith('chat_')) {
              localStorage.removeItem(key);
            }
          });
          chatbox.innerHTML = '';
          chatHistoryList.innerHTML = '';
          currentChatId = null;
        }
      };

      // Toggle dark mode
      window.toggleDarkMode = function() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', 
          document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
      };

      // API call functions
      async function askAI(query) {
        const formData = new FormData();
        formData.append('instruction', query);

        try {
          const response = await fetch('/ask', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          return data.response || "Sorry, I couldn't process your request.";
        } catch (error) {
          console.error("Error asking AI:", error);
          return "There was an error contacting the AI service.";
        }
      }

      async function uploadImage(file) {
        const formData = new FormData();
        formData.append('image', file);
        if (textInput.value.trim()) {
          formData.append('caption', textInput.value.trim());
        }

        try {
          const response = await fetch('/upload_image', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          return data.response || "Image processed successfully";
        } catch (error) {
          console.error("Error uploading image:", error);
          return "There was an error processing your image.";
        }
      }

      // Copy to clipboard function
      window.copyToClipboard = function(button) {
        const codeBlock = button.closest('.code-block').querySelector('code');
        navigator.clipboard.writeText(codeBlock.textContent)
          .then(() => {
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
              button.innerHTML = '<i class="far fa-copy"></i> Copy';
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy:', err);
          });
      };

      // Initialize chat history
      updateChatHistory();

      // Focus input field on load
      textInput.focus();
    });
  </script>
</body>
</html>
