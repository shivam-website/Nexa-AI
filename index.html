<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aivora AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">


</head>
<body>
  
<!-- Sidebar Toggle Button (Shown when sidebar is hidden) -->
<button id="showSidebarBtn" class="sidebar-show-btn" style="display: none;">â˜°</button>

  
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo">Aivora</span>
      <button id="hideSidebarBtn" class="sidebar-toggle">Ã—</button>
    </div>
  
    <a onclick="startNewChat()">+ New Chat</a>
    <div id="chat-history-list"></div>
  
    <button id="clear-chats" class="sidebar-btn" onclick="clearAllChats()">Clear All Chats</button>
    <a href="/logout" class="sidebar-btn" style="color: #ff4d4d;">Logout</a>
  </div>
  
<!-- âœ… Wrap these in .main to restore layout -->
<div class="main">
  <div class="top-bar" id="topBar">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div style="margin-left: 40px; font-weight: bold;">Aivora AI Assistant</div>
      <button onclick="toggleDarkMode()" style="background:#1abc9c; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:14px;">ðŸŒ™</button>
    </div>
  </div>
  
  
<div class="chat-container" id="chatbox"></div>

<div class="input-area">
<form id="multi-action-form" style="display: flex; width: 100%; gap: 10px;" enctype="multipart/form-data">
  <select id="action-type">
    <option value="ask">Ask AI</option>
    <option value="upload_image">Upload Image</option>
    <option value="generate_image">Generate Image</option>
  </select>

  <input type="text" id="text-input" name="instruction" placeholder="Type something..." required />
  <input type="file" id="file-input" name="image" accept="image/*" style="display: none;" />
  <button type="submit">Submit</button>
</form>
</div>

<div id="loader" class="image-box" style="display:none;">Loading...</div>
<div class="image-box" id="generated-image-container"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
// âœ… Apply dark mode if it was enabled last time
if (localStorage.getItem('darkMode') === 'enabled') {
document.body.classList.add('dark-mode');
}
const loginBtn = document.getElementById('login-btn');
let currentChatId = null;
let chatTitle = '';
const chatbox = document.getElementById('chatbox');
const chatHistoryList = document.getElementById('chat-history-list');


const textInput = document.getElementById('text-input');
const fileInput = document.getElementById('file-input');
const actionType = document.getElementById('action-type');
const loader = document.getElementById('loader');
const imageContainer = document.getElementById('generated-image-container');

function addMessage(text, type = 'bot') {
  const msg = document.createElement('div');
  msg.className = `chat-message ${type}-message`;

  // Format code blocks
  const formattedText = text
    .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
      const safeCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return `<pre><code class="language-${lang || 'plaintext'}">${safeCode}</code></pre>`;
    })
    .replace(/\n/g, '<br>'); // Optional: support single line breaks

  msg.innerHTML = formattedText;
  chatbox.appendChild(msg);
  chatbox.scrollTop = chatbox.scrollHeight;

  if (!currentChatId) {
    const userQuery = textInput.value.trim();
    chatTitle = userQuery || "Untitled Chat";
    currentChatId = chatTitle;
    localStorage.setItem("chat_" + currentChatId, JSON.stringify([]));
  }

  const chat = JSON.parse(localStorage.getItem("chat_" + currentChatId)) || [];
  chat.push({ type, text });
  localStorage.setItem("chat_" + currentChatId, JSON.stringify(chat));
  updateChatHistory();
}


function toggleDarkMode() {
const isDark = document.body.classList.toggle('dark-mode');
localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
}
async function startNewChat() {
try {
const response = await fetch('/start_new_chat', {
method: 'POST',
});
const data = await response.json();
if (data.response) {
console.log(data.response);
currentChatId = null;
chatTitle = '';
chatbox.innerHTML = '';
textInput.value = '';
fileInput.value = '';
imageContainer.innerHTML = '';
loader.style.display = 'none';
actionType.value = 'ask';
}
} catch (error) {
console.error("Error starting new chat:", error);
}


}


function updateChatHistory() {
const existingChats = new Set();
chatHistoryList.innerHTML = '';
Object.keys(localStorage).forEach(key => {
if (key.startsWith("chat_")) {
  const chatName = key.replace("chat_", "");
  if (!existingChats.has(chatName)) {
    const chatHistoryItem = document.createElement('div');
    chatHistoryItem.className = 'chat-link';
    chatHistoryItem.textContent = `Chat - ${chatName}`;
    chatHistoryItem.onclick = () => loadChat(chatName);
    chatHistoryList.appendChild(chatHistoryItem);
    existingChats.add(chatName);
  }
}
});
}

function loadChat(key) {
currentChatId = key;
chatTitle = key;
chatbox.innerHTML = '';
const messages = JSON.parse(localStorage.getItem("chat_" + key));
messages.forEach(msg => {
addMessage(msg.text, msg.type);
});
}

// Function to toggle sidebar visibility

function toggleSidebar() {


const sidebar = document.getElementById('sidebar');
if (sidebar) {
sidebar.classList.toggle('hidden'); // Use a class to hide/show
} else {
console.log("Sidebar not found!");
}
}


actionType.addEventListener('change', function () {
if (actionType.value === 'upload_image') {
fileInput.style.display = 'block';
textInput.placeholder = 'You can add a caption...';
} else {
fileInput.style.display = 'none';
textInput.placeholder = 'Type something...';
}
});

document.getElementById('multi-action-form').addEventListener('submit', async function (e) {
  e.preventDefault();
  const type = actionType.value;
  loader.style.display = 'block';
  imageContainer.innerHTML = '';

  if (type === 'ask') {
    const userText = textInput.value.trim();
    if (!userText) {
      alert("Please type your question.");
      loader.style.display = 'none';
      return;
    }
    addMessage(userText, 'user');
    const response = await askAI(userText);
    addMessage(response, 'bot');

  } else if (type === 'upload_image') {
    if (fileInput.files.length === 0) {
      alert("Please select an image to upload.");
      loader.style.display = 'none';
      return;
    }
    addMessage('Uploading image...', 'user');
    const response = await uploadImage(fileInput.files[0]);
    addMessage(response, 'bot');

  } else if (type === 'generate_image') {
    const prompt = textInput.value.trim();
    if (!prompt) {
      alert("Please enter a prompt for image generation.");
      loader.style.display = 'none';
      return;
    }
    addMessage('Generating image...', 'user');
    const imageUrl = await generateImage(prompt);
    imageContainer.innerHTML = `<img src="${imageUrl}" alt="Generated Image" />`;
  }

  textInput.value = '';
  fileInput.value = '';
  loader.style.display = 'none';
});

async function askAI(query) {
  const formData = new FormData();
  formData.append('instruction', query);

  try {
    const response = await fetch('/ask', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    if (data.response) {
      return data.response;
    } else {
      return "Sorry, I didn't get a response.";
    }
  } catch (error) {
    console.error("Error asking AI:", error);
    return "There was an error contacting the AI service.";
  }
}
async function uploadImage(file) {
return 'âœ… Image uploaded successfully!'; // Placeholder
}

async function generateImage(prompt) {
return 'https://via.placeholder.com/300x200.png?text=Generated+Image'; // Placeholder
}

function login() {
window.location.href = "/login";
}
function toggleLoginOptions() {


const options = document.getElementById('login-options');
options.style.display = options.style.display === 'none' ? 'block' : 'none';
}


window.clearAllChats = function () {
if (confirm('Are you sure you want to clear all chats?')) {
Object.keys(localStorage).forEach(key => {
  if (key.startsWith("chat_")) {
    localStorage.removeItem(key);
  }
});
chatbox.innerHTML = '';
chatHistoryList.innerHTML = '';
}
};

window.toggleDarkMode = toggleDarkMode; // âœ… Expose it globally if needed for button onclick

updateChatHistory();

});


</script>
<script>
document.getElementById('hideSidebarBtn').onclick = function () {
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('showSidebarBtn').style.display = 'block';
  document.querySelector('.main-content').style.marginLeft = '0';
};

document.getElementById('showSidebarBtn').onclick = function () {
  document.getElementById('sidebar').style.display = 'flex';
  document.getElementById('showSidebarBtn').style.display = 'none';
  document.querySelector('.main-content').style.marginLeft = '250px';
};

</script>
<script>
  const toggleBtn = document.getElementById("toggleSidebarBtn");
  const sidebar = document.querySelector(".sidebar");

  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("hidden-sidebar");
  });
</script>

</body>
</html>
